---
title: Ch3.程序的转化与机器级表示
---

# 程序转换概述
![](../../img/Pasted%20image%2020240402170220.png)
- 预处理：插入所有用#include 命令指定的文件和用#define声明指定的宏
- 编译：将预处理后的源程序文件编译生成相应的**汇编语言程序**
- 汇编：由**汇编程序**将**汇编语言源程序**文件转换为**可重定位的机器语言目标代码文件**
- 链接：由链接器将多个可重定位的机器语言目标文件以及库例程（如printf()库函数）链接起来，生成最终的**可执行目标文件**。
## 可执行文件的存储器映像
![](../../img/Pasted%20image%2020240402170411.png)
# IA-32/x86-64指令系统
## ISA
![](../../img/Pasted%20image%2020240402171151.png)
### 寻址
- 实地址模式与保护模式
- ![](../../img/Pasted%20image%2020240402170923.png)
# C语言程序的机器级表示

## 过程调用的机器级表示
![](../../img/Pasted%20image%2020240402173103.png)
- 调用者保存寄存器：EAX，EDX，ECX：P调用Q时，Q可以直接使用这三个寄存器
- 被调用者保存寄存器：EBX，ESI，EDI：Q必须先将他们的值保存在栈中再使用，并在RETURN前恢复
### 调用栈帧变化
![](../../img/Pasted%20image%2020240402173257.png)
### 过程
1. 准备阶段
	- 形成帧底：push %ebp, mov %esp. %ebp
	- 生成栈帧（若需要）：sub and
	- 保存现场（若需要）：mov
2. 过程（函数）体
	- 分配局部变量空间并赋值
	- 遇到函数调用：
		- 准备参数
		- CALL
	- 在EAX中准备返回参数
3. 结束阶段
	- 退栈：leave， pop
		- leave指令的作用：mov %ebp, %esp, pop %ebp
	- 取址返回：ret
### 入口参数位置
- IA-32中，若参数类型是unsigned char、char或unsigned short、short，也都分配4个字节
- 故在被调用函数中，使用R\[ebp\]+8、R\[ebp\]+12、R\[ebp\]+16作为有效地址来访问函数的入口参数
## 选择语句的表示
### if-else
![](../../img/Pasted%20image%2020240402180913.png)
### switch-case
![](../../img/Pasted%20image%2020240402180942.png)
## 循环语句的表示
![](../../img/Pasted%20image%2020240402184104.png)
# 复杂数据类型的分配和访问
## 数组
- 假设数组A的首地址存放在EDX中，i存放在ECX中
	- mov (%edx, %ecx, 2), %al
	- ECX为变址（索引）寄存器
## 结构体/联合
## 对齐
>i386 System V ABI对struct结构体数据的对齐方式有如下几条规则：
>1. 整个结构体变量的对齐方式与其中对齐方式最严格的成员相同；
>2. 每个成员在满足其对齐方式的前提下, 取最小的可用位置作为成员在结构体中的偏移量，这可能导致内部插空;
>3.  结构体大小应为对齐边界长度的整数倍，这可能会导致尾部插空。
>前两条规则是为了保证结构体中的任意成员都能以对齐的方式访问。
>第3条规则是为了保证使结构体数组中的每个元素都能满足对齐要求

# 越界访问和缓冲区溢出
- 超越数组存储区范围的写入操作称为缓冲区溢出
## 防范
- 地址空间随机化
- 栈破坏检测
	- 在函数准备阶段，在其栈帧中缓冲区底部与保存寄存器之间加入一个随机生成的特定值；在函数恢复阶段，在恢复寄存器并返回到调用函数前，先检查该值是否被改变。若改变则程序异常中止。
- 可执行代码区域限制
	- 通过将程序栈区和堆区设置为不可执行，从而使得攻击者不可能执行被植入在输入缓冲区的代码，这种技术也被称为非执行的缓冲区技术。